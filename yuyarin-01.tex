% -*- coding: utf-8 -*-

% TODO: 読点句読点の置換
% TODO: タイトル考える
\chapter{IRRのおはなし(仮)}
% * (アスタリスク)付きの \chapter* コマンドは原則不可とする

\begin{flushright}
 yuyarin % ペンネーム
\end{flushright}

% TODO: 最後にやる？
%\lettrine{}

%\section{はじめに}

インターネットにおけるドメイン間ルーティングでは，運用の利便性やセキュリティの面から経路情報を管理するデータベースが求められている．
それがIRR(Internet Routing Registry)というシステムである．
本稿ではIPルーティングの基礎をおさらいした後に，ドメイン間ルーティングの運用と経路ハイジャックの問題について述べ，IRRをの仕組みと現状を紹介する．

% 最初の方省略するときは書く
%
%この記事ではIP通信の基礎(IPアドレスとサブネット，パケット転送の仕組み)に関する知識を有していることを前提とします．
%192.0.2.0/25, 2001:db8:10::/48, サブネット，ルータ，などのキーワード

% TODO: セクション区切りを考える
\section{IPルーティング}

\subsection{IP}

% 紙面が足りなければ省略する
現在のインターネットを実現する技術の１つとしてIP(Internet Protocol)という通信プロトコルが利用されている．
IPの役割はネットワーク内のノード間の到達性を実現し，パケットという単位に分割されたデータを宛先ノードに送り届けることである．

IPネットワークではIPアドレスによりノードを識別している．
IPv4ではアドレス長は32 bitで192.0.2.1のように表現され，IPv6ではアドレス長は128 bitで2001:db8:10::cafeのように表現される．

送信元ノードは宛先ノードにパケットを転送可能である隣のノードにパケットを送信する．
中継ノードは更に隣のノードにパケットを転送し，最終的に宛先ノードにパケットが到達する．
一般にパケットを送信するノードをホストと呼び，パケットを転送するノードをルータと呼ぶ．

\subsection{サブネット}

% 紙面が足りなければ省略する
% 図を書く？
IPのノードで区切られた１つのネットワークは\textgt{サブネット}(セグメント)と呼ばれる．
同一サブネット内のノードでは先頭のいくつかのbitが同じアドレスが利用され，ルータを介さずに直接通信が可能である．

例えば192.0.2.0から192.0.2.127までの128個のアドレスを持つサブネットは192.0.2.0/25と表現される．
サブネットの先頭のアドレス192.0.2.0はネットワークアドレスと呼ばれ，/25は先頭25 bitが同じであることを意味している．
この192.0.2.0/25は\textgt{prefix}と呼ばれ，そのうち/の後ろの25は\textgt{prefix長}と呼ばれる．

同じ組織で192.0.2.128/25というサブネットも利用していた場合，
この組織のネットワークは２つを合わせて192.0.2.0/24と表現できる．
複数のサブネットをまとめて１つのprefixで表現する事を\textgt{集約(aggregation)}と言う．
内部的なサブネットを意識しない場合，便宜的に「192.0.2.0/24のネットワーク」などと呼ぶ．

\subsection{経路交換とルーティング}

% 図を書く？
宛先に対してパケットを届けるためには，どのルータにパケットを転送すればよいかを知る必要がある．
パソコンなどのエンドホストは出口になっているルータ(デフォルト・ゲートウェイ)にパケットをすべて送ればよいが，途中のルータはそうはいかない．
そのためにはルータ間で自分の到達可能な宛先ネットワークの情報を交換する．これを\textgt{経路交換}と呼ぶ．
経路交換を行い，集められた経路情報からパケットを送信する経路を決定することを\textgt{ルーティング}と呼び，そのためのプロトコルを\textgt{ルーティングプロトコル}と呼ぶ．

経路は大きく分けて，\textgt{宛先ネットワーク}，\textgt{ネクストホップ}，\textgt{メトリック}の３つの情報で構成される．
宛先ネットワークは192.0.2.128/25のようにprefixで表現される．
ネクストホップは宛先ネットワークにパケットを送るために次にパケットを転送するノードのアドレスである．
メトリックは宛先ネットワークに対して複数のネクストホップがあった場合にどのネクストホップを優先するかを決めるための値である．
この値の内容はルーティングプロトコルによって異なる．


\subsection{ASとドメイン間ルーティング}

% 図を書く？
１つの同じポリシーで運用されるネットワークの範囲を\textgt{ドメイン}と呼ぶ．
また，このドメインを\textgt{AS(Autonomous System, 自律システム)}と呼び，4 byteの一意な番号である\textgt{AS番号}によって区別される．
インターネットはASという自律的なネットワークが相互に接続した「ネットワークのネットワーク」である．

ASの内部で行われるルーティングを\textgt{ドメイン内ルーティング(Intra-domain Routing)}と呼ぶ．
ドメイン内ルーティングは各ASで好きなように行うことができる．
日本ではOSPF，北米ではIS-ISが主なルーティングプロトコルとして利用されている．

ASの間で行われるルーティングは\textgt{ドメイン間ルーティング(Inter-domain Routing)}と呼ぶ．
ドメイン間ルーティングは全世界のすべてのASで共通のルーティングプロトコルを利用しなければならず，現在はBGP4が利用されている．
ドメイン間ルーティングではドメイン内のルーティングは隠蔽されている．

自身の管理する経路を経路交換を通じて全世界に伝えることを\textgt{経路広告}と呼び，ある経路について経路広告を行なっているASのことをOrigin ASと呼ぶ．

\section{インターネットの資源管理}

% ここは短くできる
\subsection{階層的な資源管理}

インターネットは自律的なシステムではあるが，AS番号やIPアドレスなどの資源は重複利用が生じないように誰かが統一的に管理を行わなければならない．

これらの資源はIANA→RIR→NIR→LIRという組織の順に階層的に管理されている．
下位組織に資源を託すことを\textgt{割り振り(Allocation)}と呼び，IRがエンドユーザに資源を貸すことを\textgt{割り当て(Assignment)}と呼ぶ．
% 図を書く？

IANA(Internet Assigned Numbers Authority)は最上位の組織であり，AS番号やIPアドレスの他に，
DNSのTLD(Top Level Domain)やプロトコルの番号などを管理する権限(Authority)を持っている．

RIR(Regional Internet Registry)は世界の地域ごとの管理組織のことである．
インターネットに関係する資源を管理する組織のことをインターネットレジストリと呼ぶ．
RIRには北米のARIN，中南米のLACNIC，欧州中東のRIPE NCC，アフリカのAfriNIC，アジア太平洋地域のAPNICの５つの組織がある．

NIR(National Internet Registry)は各RIRの下位組織である．日本ではJPNIC(日本ネットワークインフォメーションセンター)がNIRであり，RIRであるAPNICの下位組織である．

LIR(Local Internet Registry)は日本の場合，ISPなどのIPアドレス管理指定事業者のことである．

% 長くなったら削ってもいい
\subsection{AS番号とIPアドレスの取得}

AS番号は要件を満たせば誰でも取得することが可能である．JPNICでは下記の3つの要件を満たせば，初期費用262,500円，年額52,500円で取得可能である．

\begin{enumerate}
\item ASがBGPを利用して他のASとの間で経路交換すること
\item ASの外部経路制御ポリシが他のASに委ねられない固有のものであること
\item 条件 1, 2 を割り当てから3ヶ月以内に満たす予定であること
\end{enumerate}

IPアドレスを日本で取得する場合，以下の３つのパターンがある．

\begin{enumerate}
\item LIRから割り当てを受ける
\item LIRとしてJPNICから割り振りを受ける
\item JPNICから直接割り当てを受ける
\end{enumerate}

多くの場合はパターン1であるが，自身がISPなどの事業者として取得するときはパターン2である．
パターン3はASの運用をする場合などに用いられ，割り当てられるアドレスはPI(Provider Independent)アドレスと呼ばれる．
パターン1によって取得されるアドレスは，上位プロバイダで集約可能なためPA(Provider Aggregatable)アドレスと呼ばれる．
% 削るのここまで

AS番号もIPアドレスもそれぞれが取得を申請した組織や個人に割り当て/割り振られるため，AS番号とIPアドレスは資源管理上は直接の関係性を持っていない．

\section{インターネットの構造とドメイン間ルーティングの運用}

\subsection{AS間の関係}

ドメイン間ルーティングの話に戻ろう．
インターネットはASが相互接続してできたネットワークであるという話をしたが，すべてのASが対等に接続しているわけではない．
AS間の関係には大きく分けて上下関係のトランジット(transit)と対等な関係のピア(peer)の２つが存在する．
このASの強弱関係は接続しているASの数や知っている経路の数，つまり到達性の広さで決まってくる．

トランジットはお金を支払って他のASから接続性を買う関係である．
接続性を売る側を親AS，買う側を子ASと呼ぶ．
我々一般のインターネットユーザはISPから接続性を買っているが，それをASのレベルで行うことである．
アドレスは親ASから割り当てられるものを使う方法と，自身で取得したものを使う方法の２通りがある．
親ASは子ASに対して全世界のネットワークに対する経路を広告し，子ASは自身の経路を親ASに全世界に対して広告してもらう．
トランジットでは流れるトラフィック量に応じてMbps単価で月額料金が課金されることが多い．
この辺のお金の話はまた機会があればしましょうか．

ほとんどのASはトランジットを上位のASから購入しており，最上位のASはTier 1と呼ばれ，ほぼお互いに接続している．
現在14ほどのASがTier 1とされており，日本の事業者ではNTT CommunicationsのAS2914が唯一のTier 1である．

ピアは強弱関係の似たAS同士が無償で経路交換を行う関係である．
もともとトランジットを通して行われていたトラフィック交換をピアによって直接行うことにより，トランジットの使用料を下げることができる．

このようにAS間の接続関係は強弱と経済性にもとづいて行われている．

\subsection{経路フィルタ}

他のASとの相互接続を行うルータでは，意図しない接続相手から意図しない経路を広告されて，
トラフィックが意図しない流れ方をしないように，広告されてくる経路に対してフィルタを行なっている．

\subsection{パンチングホール}

\section{ルーティングの問題}

\subsection{経路ハイジャック}

\section{IRR}

\section{IRRの問題}



%経路広告
%AS
%インターネットで管理されている資源
%- IPアドレス
%- ドメイン
%- AS
%BGP
%経路広告の問題
%フィルター
%ハイジャック
%経路の正当性の問題
%　割り振りとOriginは違う
%
%whois
%RPSL
%
%IRR
