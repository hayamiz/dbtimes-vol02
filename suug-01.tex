% -*- coding: utf-8 -*-

\chapter{DNSは崩壊しました（仮）}
% * (アスタリスク)付きの \chapter* コマンドは原則不可とする

\begin{flushright}
 {\headfont suu-g (@suu\_g)}
\end{flushright}

\section{はじめに}

% TODO: 書く

なお筆者は趣味のDNS運用者であり趣味のDNS勉強者であるだけなので、
この文章に書かれたことについては一切、責任を持てません。

\section{DNSと攻撃}

% TODO: 攻撃シナリオここ

\section{UDP（笑）}
DNSの脆弱性は、基本的にはそれがUDPの上で動いていることに起因します。

% TODO: ここにUDPパケットフォーマットの図と解脱

% TODO: ここにDNSパケットフォーマットの図と解脱

DNSへの攻撃はもうUDPを使っているせいなんですが、じゃあTCPを使おうと
言うと、今度はDNS運用者からの猛烈な反対に遭います。

TCPは状態を持ち、意外と限られているリソースを消費してしまうため、
短時間で大量のクエリを捌く必要のあるDNSサーバとしては使用したくない
のですね。

DNSのルートサーバに求められる性能は10kqps以上はあります。大規模な
プログラムをTCPで組んで運用したことのある方なら経験があるかも知れ
ませんが、TCPにはTIME\_WAIT状態があり、通信が終了したあとになって
もしばらくはそのポート番号を使用することができません。したがって、
UDPの場合と比較してより長い間、ポート番号を実時間で占拠することに
なります。

状態を保存する問題は他の部分にもあって、ファイアーウォールやロード
バランサーでも同様のことが起き得ます。
もっとも、この問題はポート番号がプロトコル上の制限により16bitしか
ないということも大きな原因なので、FWやLBでは問題はより小さいでしょう。 
ともあれ、現状では「全てのUDPのDNSパケットを生まれる前に消し去りたい、
全てのDNSパケットを、TCP上に」という祈りは、因果律に対する反逆です。
ポート番号が増えればまだ考えられますけどね。

とは言うものの、セキュリティを意識したDNSを現実的に実装するためには、
現状ではTCPよりも良い手段はありません。

\subsection{DNSSECとEDNS0}
ポート番号やクエリIDでメッセージの真正性を担保できない、ということが
ここでの問題です。言い方を変えると、真正性を担保できるのであれば、
別にUDPのままでもいいわけです。

というわけで、DNSSEC + EDNS0 です。DNSSECは信頼のチェーンを公開鍵を
用いて構成していく手法で、これなら確かにUDPを用いたままでもメッセージの
真正性を確認できます。いや、できそうに見えます。

大変遺憾なことに、現状のDNSSECのパケットはUDPの1パケットに収まらない
程度に大きくなりそうだという問題があります。2012年11月の時点では、
 dig +vc jprs.jp rrsig とするとパケットがtruncateされ結果TCPフォール
バックが起こる様子が観察できます。これは本来1656バイトのメッセージサイズ
を持つので、当然TCPフォールバックが必須なわけです。 % TODO: 日本語でおｋ

『DNSSECが最終的にTCPを必要とするのであれば、もともとDNSSECがなんのために
導入されたのか謎。TCPならそもそもこの問題が起きないなので、 DNSSECとか
要らないわぁ』という論調があります。 単純にトランスポートの安全性 を保つ
意味合いであればそのとおりかなと思います。
（この点については深堀りは避けます） % TODO: 脚注にする

もっとも、AやAAAAレコードとそのRRSIGレコードのみを持っているようなドメイン
を考えると、まず1200バイトも行かないでしょうし、そういうドメインへの
問い合わせが大多数になるでしょうから、末端のサーバに関してはDNSSECによって
サーバ負荷を減らすことは可能になりそうではあります。
% TODO: 予想されるパケットサイズとパケットの種類の表

% TODO: 以下適当なので直す
\section{あのー、RFCに書いてないんですけど…}
1997年、Kashpureff型の攻撃あり、乗っ取られたyo。

関係のないサイトの情報をadditional sectionに入れ、それをキャッシュサーバに
キャッシュさせることによって以下略。

これはRFC違反じゃなく、未定義動作。そもそもDNSのRFCにAdditional Sectionが
どう使われる "べき" か書かれていない。全くどうしようもないプロトコルさん
ですね。

今は直っているが、こういう具合に実装に任せた部分がプロトコルに多く存在して
いて、ちょっとプロトコルとしてどうなのよという。

\section{お誕生日問題}
23人いると1/2くらいの確率で誕生日が同じ人がいるらしい、というところ。
つまりたくさん試せば毒が入るかも知れない。けれどキャッシュにはTTLがあって、
毒入れに一度失敗するとしばらく入りません。

一定以上に長いTTLがあれば、それなりに安全だろうと思われていました。


\section{そしてカミンスキーへ…}
カミンスキーは三つの問題の組み合わせ。
UDP問題、キャッシュ回避、プロトコル問題。UDP問題は省略。

お誕生日問題があるといえど、キャッシュのTTLがあるので毒入れは現実的には
それなりに困難だろうと思われていました。それを覆したのがこのカミンスキー
型攻撃、通称カミンスキーアタックです。% TODO: 脚注『カミンスキーアタック言うな』

カミンスキーアタックのキモはキャッシュ回避のための手法。
あるドメインへの攻撃のために、そのドメインのTTLが切れるのを待つ必要が
ないという画期的な攻撃です。

ただ、本来はそれで毒が入るのは実装のミスというか。これもDNSのプロトコル問題
ガッパオ。

という内容を少しまともに書く。
