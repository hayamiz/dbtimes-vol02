% -*- coding: utf-8 -*-

\chapter{Hadoopつかったら負けかなと思ってる}

\begin{flushright}
 {\headfont はやみず}
\end{flushright}

\section{MapReduceとHadoop}

2012年現在，大規模なデータ処理に関わる技術者のなかで，
MapReduceあるいはHadoopという言葉を聞いたことがない方はいないでしょう。

MapReduceは2004年にGoogleによって提唱された，
大規模データを並列分散処理するためのフレームワークです。
Googleは実際に社内でMapReduceを使っていたらしいですが，
ソフトウェア自体は公開されておらず，
実際にMapReduceを誰もが使えるという状況にはありませんでした。

その状況を変えたのがHadoopの登場です。
端的に言うと，HadoopとはJavaによるMapReduceの実装です。
Apache Nutchという全文検索エンジン基盤のために実装され始めたHadoopですが，
2006年にApache Hadoopプロジェクトとしてとして独立します。
もともとはMapReduceを出発点として開発が始まったHadoopですが，
現在ではHadoop分散ファイルシステム(HDFS)の上でMapReduce以外の方法でデータ処理を行うことも可能であり，
現在においてはかならずしも「単なるMapReduceの実装」として見るのが正しいとはいえません。
むしろ，MapReduceを核として発展した並列分散データ処理のためのソフトウェアエコシステムというのが，
現在におけるHadoopの姿であるといえるでしょう。

\section{データベース業界からのMapReduce批判}

2009年，Web上にある記事が公開されて大きな話題を呼びました。
``MapReduce: A major step backwards'' と題されたその記事は，
当時のクラウドコンピューティングブームも相まって大流行していたMapReduce(あるいはHadoop)を痛烈に批判するものでした。
日本語にするならば「MapReduce: 大きな技術的後退」となるでしょうか。
タイトルからして挑戦的なその記事は，手厳しくMapReduceのことを批判しています。

記事の中に要点のリストがあるので，拙訳とともに引用します：

\begin{quote}
\begin{enumerate}
 \item A giant step backward in the programming paradigm for large-scale data intensive applications \\
	   大規模データインテンシブアプリケーションにおけるプログラミングパラダイムの大いなる後退
 \item A sub-optimal implementation, in that it uses brute force instead of indexing \\
	   索引を使わない総当り方式の，およそ最善とは言いがたい実装
 \item Not novel at all -- it represents a specific implementation of well known techniques developed nearly 25 years ago \\
	   全く新規性に欠ける -- 25年近く前に開発された手法の限定的な実装でしかない
 \item Missing most of the features that are routinely included in current DBMS \\
	   現代のDBMSがごく当たり前に持っている機能の殆どが欠けている
 \item Incompatible with all of the tools DBMS users have come to depend on \\
	   DBMSユーザが使っているツールのほとんど全てと互換性がない
\end{enumerate}
\end{quote}

この記事を書いたのはDavid J. DeWitt と Michael Stonebraker \footnote{RDBMSを世界で最初に実装したStonebrakerの功績は The Database Times vol.1 を参照のこと}の2人です。
この2人は，データベース分野において最も権威ある賞の1つである SIGMOD Edgar Codd Award を共に受賞しており，
まさにデータベース業界を代表する大御所2人といっても過言ではありません。
その2人からこれだけ厳しい言葉で批判されたわけですから，
MapReduceとHadoopはデータベース業界自体から手厳しい批判を受けたといっても過言ではないでしょう。

「大いなる後退」「およそ最善とは言いがたい実装」「全く新規性に欠ける」「機能が欠けている」
などなど，実に厳しい言葉を並べてMapReduceが批判されており，
さながら「MapReduceなんていうのはデータベース業界からすればオモチャでしかない」
とでも言いたげです。

DeWittやStonebrakerだけでなく，
データベース業界の人々はMapReduceが登場する何十年も前から並列データベースシステムの研究に取り組み，
並列分散データ処理に関して非常に高度な技術を開発し，積み重ねてきました。
それらに比べると，MapReduceはよく言うとシンプルな，
悪く言うとお馬鹿な方法で，\bou{とりあえず}並列分散データ処理ができる方法と位置づけられます。
多くの研究者により連綿と研ぎ澄まされてきた並列データベース技術の歴史を飛び越して，
MapReduceのようなある意味``下品''な方法論が世に広く受け入れられている状況は，
データベース業界からすると決して面白いものではなかったのでしょう。
そう考えると，
この記事は「我々の技術のほうが優れているはずなのに」
という DeWitt と Stonebraker の壮大な負け惜しみのようにも思えてきます。

\begin{figure}[t]
\begin{screen}
 \noindent{\sf コラム：歴史は繰り返す？}
 \vspace*{3mm}

 ある時点における業界の権威達が「こんなものはオモチャだ」と批判した技術が，
 やがて世を席巻し，権威を飲み込んでしまう。
 これはクリステンセンのいう{\em イノベーションのジレンマ}であり，
 コンピュータの歴史においてたびたび繰り返されてきました。

 たとえばデータベース史を振り返ると，
 Edgar F. Coddが提唱し，
 Michael Stonebraker がINGRESプロジェクトで世界で初めて実装したリレーショナルデータベースは，
 当時のデータベース業界の巨人であるIBMからはまさにオモチャ扱いされていました。
 リレーショナルデータベースを提唱したCoddがIBMの研究者であったのは歴史の皮肉ともいえるでしょう。
 メインフレームマシンに階層型データベースが主流である時代に，
 DECのミニコン上で動く処理性能の低いリレーショナルデータベースは，
 IBMからすればまさにオモチャ以外の何者でもなかったのかもしれません。
 しかし，ユーザの利便性において大きくまさるリレーショナルデータベースが徐々にその勢いをましてゆき，
 ついにはIBMもリレーショナルデータベース市場へと舵を切らざるをえないと判断をするに至りました。

 リレーショナルデータベースの黎明期には「オモチャだ」と批判される側にいたStonebrakerが，
 今度はMapReduceを「オモチャだ」と批判する側にまわっているのが面白いですね。
 ただ，Stonebrakerのすごいところは単に批判するだけではなく，
 そこから新たなものを生み出してきてしまうことです。
 あるとき「NoSQLはリレーショナルデータベースより速い」という主張を手厳しく批判したStonebrakerは，
 そのしばらく後にOLTP向けの爆速DBMSであるVoltDBをつくりだしてしまいました。
\end{screen}
\end{figure}

MapReduceをオモチャだと揶揄するような彼らの批判は，
しかしながら歴史に裏付けされた確かな技術をもとにして語られています。
Hadoopは流行にのって広く普及するには至りましたが，
その進化の方向性を観察していると，
まさしく彼らが指摘した欠点を補う方向に向かっていることがわかります。
その1つの方向というのが，まさにSQL，そしてリレーショナルデータベースへの回帰なのです。

\section{結局SQL}

正規化されていないデータ(非構造化データ)と，それを扱うための手続きさえ与えれば，
簡単に並列データ処理ができるというところからMapReduceは始まりました。
しかしながら，結局はSQLの世界へと回帰してゆきます。
即ち，正規化されたデータと手続きのない世界です。

非構造化データに手続きを与えてデータ処理をするというのは，
パラダイムとしては1960年代に逆戻りするようなものです。
処理対象がある程度複雑になってくると，
普通のプログラマがこのやり方できちんとデータ処理をするのは現実的ではありません。
だからこそ，リレーショナルデータベース，そしてSQLが発明されたわけです。

SQLの偉大な点は，{\em 宣言的な記述}によってデータ処理を行うという考え方を世間一般に普及させたことです。
具体的にデータをどう読み書きし，どう処理するかということはDBMSの中にブラックボックス化され，
アプリケーションプログラマは「自分はどんなデータ/処理結果が欲しいか」
だけに集中することができます。
\footnote{もちろん，DBMSの中で具体的な処理がどのように行われているのか，
アプリケーションプログラマも知っているにこしたことはありません。
ただし，「知らなくても使える」というのは重要なことです。}
どの索引を使ってどのファイルからデータを読み込むのか，
ネストループ結合をつかうのかハッシュ結合を使うのか，
ソートはオンメモリでやるか外部ソートを使うか，
こういったデータ処理のための{\em 手続き}からプログラマを解放したのがSQLなのです。

何から何までこなせるスーパープログラマは別として，
普通のプログラマが使うことのできるデータ処理基盤を作るためには，
SQL(あるいはそれにかわる何か)が必要であることは間違いありません。
このことは，最近のMapReduceやHadoopに関する情勢を見ていれば明らかでしょう。

2008年にfacebookでHiveプロジェクトが始まりました。
Hiveとは，平たく言えばHadoop上のSQL処理エンジンです。
HiveQLと呼ばれるSQLライクなクエリ言語で処理をクエリを記述すると，
それがHadoopクラスタ上でMapReduceタスクに変換されてデータ処理が行われます。
最近何かと話題のTreasure Dataが提供するクラウド上のデータ処理基盤も，
HiveQLを使ってデータ解析を行うことができるようになっています。

2010年には，GoogleがBigQueryを発表します。
BigQueryはGoogleのクラウド基盤上でSQLを走らせてデータ処理を行うことができるサービスです。
BigQueryの内部では，Dremelと呼ばれるクエリ処理システムが用いられています。
また，Dremelのオープンソース実装としてClouderaにより開発されたImpalaが2012年にリリースされ，
Hadoop技術者の間で話題を集めました。

もちろん，すべてのことがSQLで出来るわけではありません。
しかし，SQLの世界で出来ることは，SQLの世界でやるに越したことはありません。
それはつまり，過去数十年にわたってデータベース研究の世界で築きあげられた技術を活かし，
「巨人の肩に立つ」ことに他ならないからです。

\section{結局並列データベース}

MapReduceの出発点は，とにかくシンプルな並列分散処理フレームワークでした。
しかし，それゆえにMapReduceの処理効率は悪くならざるを得ません。
例えばMapReduceの基本は全データスキャンによるデータ処理です。
Googleがクロールしたデータを処理するにはそれで良いのかもしれませんが，
大量に蓄積したデータの一部のみを処理したい場合には，効率が悪すぎます。

そこで，Hadoopに並列データベースの技術を取り込もうという動きが見られます。

代表的なものを挙げるとするならば，HadoopDBとHadoop++でしょう。
Yale大学が開発したHadoopDBでは，Hadoopの中でもHDFSをRDBMSに置き換えることで，
各ノード内部での処理を高速化しています。
2011年には，HadoopDBプロジェクトのメンバが企業し，Hadaptとして商業化しました。
また，Saarland大学の開発したHadoop++では，
HadoopのMapReduceのアーキテクチャを一切変えること無く，
クラスタ化索引やパーティショニングなどの並列データベース技術の適用を実現できる機構が提案されています。

また，GoogleのDremelやClouderaのImpalaは，
そもそもMapReduce自体をすっ飛ばしてしまって並列クエリ処理エンジンを構築しています。
ImpalaはHDFSをストレージとして使っているため，
Hadoopクラスタの上で動作させる形とはなっていますが，
これはもはや並列データベース以外の何者でもないでしょう。

\section{Hadoop使ったら負けかなと思っている}

最後に，DeWittとStonebrakerのMapReduce批判をもう一度引用します。

\begin{quote}
\begin{enumerate}
 \item 大規模データインテンシブアプリケーションにおけるプログラミングパラダイムの大いなる後退
 \item 索引を使わない総当り方式の，およそ最善とは言いがたい実装
 \item 全く新規性に欠ける -- 25年近く前に開発された手法の限定的な実装でしかない
 \item 現代のDBMSがごく当たり前に持っている機能の殆どが欠けている
 \item DBMSユーザが使っているツールのほとんど全てと互換性がない
\end{enumerate}
\end{quote}

並列データベースの世界からみれば，
Hadoopが上記の欠点を抱えているということは間違いありません。

ではなぜ，人々はHadoopを使うのでしょう。
いろいろな考え方はあると思いますが，私の答えは「それがオープンだったから」です。

並列データベースはこれまで様々な研究が行われ，
そして様々な製品が生み出されてきました。
しかし，基本的に並列データベースの製品はプロプライエタリであり，
高いライセンス料金を支払わないと利用できないものでした。
並列データベースを必要とするほどのデータを持つ人が僅かしかいない時代には，
それでよかったのかもしれません。

しかし，時代は変わりました。

個人が当たり前のように情報端末を持ち，
常にネットワークに接続されるようになった今日，
ありとあらゆる活動がネットワークを通して行われるようになりました。
1人のプログラマが数十万・数百万のユーザに使われるサービスを運用することも何ら不思議のないこの時代においては，
あらゆる場所で膨大なデータが生み出され，蓄積されてゆきます。

そんなときに登場したHadoopは，
大げさに言えばすべての人類に並列データ処理の技術をもたらしたと言ってよいでしょう。
Linuxが登場したときにも，商用のUNIXに比べればあれができない，これがダメだと様々なことが言われてきました。
しかし，今や周りを見渡せば業務用サーバから家電に至るまで，
あらゆるところでLinuxが使われています。
Hadoopは，まさにこれと同じ事をデータ処理の世界で起こしつつあるように思います。

人類に並列データ処理をもたらしたHadoopは，
並列データベースの技術を糧としてこれからも進化を続けるでしょう。
その先にあるものは，今我々が知っているHadoopでも，並列データベースでもない技術かもしれません。
そしてデータベース技術に関わる者としては，
願わくばそれを創りだす過程に貢献したいという思いもあります。
だからこそ，それを楽しみにする1人の技術者としては，Hadoop使ったら負けかなと思っている。
